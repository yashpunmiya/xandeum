# PRODUCT REQUIREMENT DOCUMENT: XandScan (Xandeum Node Analytics)

## 1. EXECUTIVE SUMMARY
Build a full-stack, production-grade analytics platform for the Xandeum Storage Network (Solana L2). The goal is to track, score, and visualize "pNodes" (storage providers).
**Key Challenge:** Most nodes are behind firewalls. The system must handle "Gossip-only" nodes (basic info) vs. "RPC-enabled" nodes (full stats) gracefully without crashing.

## 2. TECH STACK & ARCHITECTURE
* **Framework:** Next.js 14 (App Router) - TypeScript.
* **Database:** Supabase (PostgreSQL).
* **Styling:** Tailwind CSS + Shadcn/UI (Dark Mode, "Cyberpunk" aesthetic).
* **Maps:** `react-leaflet` (OpenStreetMap) with clustering.
* **Charts:** `recharts` (Responsive, gradient filled).
* **State/Fetching:** `swr` or `tanstack-query`.
* **Icons:** `lucide-react`.

---

## 3. DATABASE SCHEMA (SUPABASE)
*Generate and run this SQL in the Supabase SQL Editor:*

```sql
-- Table 1: Registry of unique nodes (The "Phonebook")
CREATE TABLE nodes (
  pubkey TEXT PRIMARY KEY,
  ip_address TEXT,
  gossip_port INT DEFAULT 9001,
  rpc_port INT DEFAULT 6000,
  country TEXT DEFAULT 'Unknown',
  city TEXT DEFAULT 'Unknown',
  latitude FLOAT,
  longitude FLOAT,
  isp TEXT,
  first_seen_at TIMESTAMPTZ DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ DEFAULT NOW(),
  is_active BOOLEAN DEFAULT TRUE
);

-- Table 2: Time-series data for graphs (The "History")
CREATE TABLE snapshots (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  node_pubkey TEXT REFERENCES nodes(pubkey),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Metadata
  version TEXT,
  credits INT DEFAULT 0,
  
  -- Performance Stats (Nullable because RPC might fail)
  rpc_active BOOLEAN DEFAULT FALSE,
  cpu_percent FLOAT,
  ram_used BIGINT,
  ram_total BIGINT,
  uptime_seconds BIGINT,
  storage_used BIGINT,
  
  -- Calculated Score
  total_score FLOAT DEFAULT 0
);

-- Index for fast querying of history
CREATE INDEX idx_snapshots_pubkey_time ON snapshots(node_pubkey, created_at DESC);
4. BACKEND LOGIC (THE INDEXER)
Create a Next.js API Route: GET /api/cron/update-nodes. Security: Require Authorization: Bearer [SECRET_KEY].

ALGORITHM:

DISCOVERY (Gossip):

Target Entry Nodes: ["192.190.136.28", "192.190.136.36", "192.190.136.37", "192.190.136.38"].

Send POST to port 6000 or 9001: {"jsonrpc": "2.0", "method": "get-pods", "id": 1}.

Output: List of pubkey, address, version.

Action: Upsert into nodes table.

ENRICHMENT (Loop through all found nodes):

Get Credits: Fetch https://podcredits.xandeum.network/api/pods-credits. Match via pubkey.

Get Geo (Rate Limited): If node has no lat/lon in DB, fetch from http://ip-api.com/json/{ip}. Constraint: Max 40 reqs/min.

Get RPC Stats (The Fallback Logic):

Try http://{ip}:6000/rpc. Method: get-stats.

If timeout/fail, try http://{ip}:{gossip_port}/rpc.

If success: rpc_active = true, save CPU/RAM/Uptime.

If fail: rpc_active = false, save NULL for stats.

SCORING (Dynamic):

Identify network_version (The most common version string in the list).

Calculate Score (0-100) for each node:

Uptime (40%): min(100, uptime_seconds / 3600) (0 if RPC fail).

Credits (30%): min(100, credits / 1000).

Version (20%): 100 if matches network_version, else 50.

Resources (10%): 100 - cpu_percent.

Action: Insert row into snapshots table. Update last_seen_at in nodes table.

5. API ENDPOINTS (FOR FRONTEND)
GET /api/nodes

Query Params: sort_by (score, credits, uptime), order (asc, desc), search (ip, country).

Logic: specific SQL query to join nodes with the latest snapshot for each node.

Return: JSON array of nodes with current stats.

GET /api/nodes/[pubkey]/history

Logic: SELECT * FROM snapshots WHERE node_pubkey = ? AND created_at > NOW() - INTERVAL '24 HOURS' ORDER BY created_at ASC.

Use: For drawing the CPU/Uptime line charts.

GET /api/network-stats

Return: Total Nodes, Active RPC Count, Top Country, Total Network Storage.

6. FRONTEND UI (DETAILED)
Theme: Dark Mode. Background #09090b. Primary Accent #22c55e (Green). Cards have thin borders #27272a.

Component 1: The Global Map

Full width map.

Markers:

Green Pulse: Score > 80 (Healthy).

Yellow Dot: Score < 50 or No RPC.

Popup: "IP: 1.2.3.4 | Score: 92 | ðŸ‡«ðŸ‡· France".

Component 2: The Data Table (Sortable)

Columns: Rank | Node (IP + Flag) | Version | Status (RPC Active/Dead) | Credits | Uptime | Score.

Feature: Clicking a header sorts the table.

Feature: "RPC Active" is a green badge, "Gossip Only" is a gray badge.

Component 3: Node Details Page (/node/[pubkey])

Header: Large Score gauge (0-100).

Grid: 4 Cards (CPU, RAM, Disk, Uptime). Display "N/A" if RPC inactive.

Charts:

"Performance History": Line chart of CPU % (last 24h).

"Reliability": Bar chart of Uptime.

7. AUTOMATION & DEPLOYMENT
Vercel Cron: Create vercel.json:

JSON

{
  "crons": [{ "path": "/api/cron/update-nodes", "schedule": "*/10 * * * *" }]
}
Environment Variables:

NEXT_PUBLIC_SUPABASE_URL

NEXT_PUBLIC_SUPABASE_ANON_KEY

CRON_SECRET (For securing the update endpoint)

8. IMPLEMENTATION ORDER
Setup: Init Next.js project & Supabase Client.

Database: Run SQL migrations.

Backend: Build the /api/cron indexer. Test it manually with Postman.

API: Build the read-only endpoints (/api/nodes).

Frontend: Build the Dashboard (Map + Table).

Frontend: Build the Details Page (Charts).

Deploy: Push to Vercel and enable Cron.